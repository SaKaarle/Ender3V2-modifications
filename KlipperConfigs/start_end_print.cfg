[gcode_macro START_PRINT]
gcode:
    # Get current printer limits
    {% set current_max_z_velocity = printer.configfile.settings["printer"].max_z_velocity %}
    {% set current_max_velocity = printer.toolhead.max_velocity %}
    {% set current_max_accel = printer.toolhead.max_accel %}
    {% set current_max_z_accel = printer.configfile.settings["printer"].max_z_accel %}

    # Print current limits to console
    RESPOND MSG="Current max Z velocity: {current_max_z_velocity} mm/s"
    RESPOND MSG="Current max XY velocity: {current_max_velocity} mm/s"
    RESPOND MSG="Current max acceleration: {current_max_accel} mm/s²"
    RESPOND MSG="Current max Z acceleration: {current_max_z_accel} mm/s²"
    # Use absolute coordinates
    G90

    # Reset the G-Code Z offset (adjust Z offset if needed)
    SET_GCODE_OFFSET Z=0.0
    # 5% fan speed
    M106 S12.8

    # Set bed temperature (asynchronously)
    M140 S{params.BED_TEMP|default(60)|float}

    # Wait for bed to reach temperature
    M190 S{params.BED_TEMP|default(60)|float}

    # Home the printer (uses homing_speed from printer.cfg)
    G28

    # Move nozzle to Z65 and X235 using current max speeds
    G1 Z65 F{current_max_z_velocity * 60}
    G1 X{printer.toolhead.axis_maximum.x - 10} F{current_max_velocity * 60}

    # Preheat extruder to 150°C for G29 (only if not already hot)
    {% if printer.extruder.temperature < 140 %}
        RESPOND MSG="Waiting for Extruder temperature to reach: 150 Celsius"
        M109 S150
    {% elif printer.extruder.temperature > 155 %}
        RESPOND MSG="Extruder already hot, skipping pre-heat for G29 (current: {printer.extruder.temperature}°C)"
    {% else %}
        RESPOND MSG="Extruder temperature is close to target, skipping pre-heat for G29 (current: {printer.extruder.temperature}°C)"
    {% endif %}

    # Run bed leveling (G29)
    G29

    # Move nozzle to Z65 and X235 again using current max speeds
    G1 Z65 F{current_max_z_velocity * 60}
    G1 X{printer.toolhead.axis_maximum.x - 13} F{current_max_velocity * 60}

    RESPOND MSG="Waiting for Extruder temperature to reach: {params.EXTRUDER_TEMP|default(190)} Celsius"
    # Set and wait for extruder temperature (use slicer's target temperature)
    M109 S{params.EXTRUDER_TEMP|default(190)|float}

    # Move to Y0 and run LINE_PURGE
    G1 Y0
    LINE_PURGE

[gcode_macro END_PRINT]
gcode:
    {% set current_max_z_velocity = printer.configfile.settings["printer"].max_z_velocity %}
    {% set current_max_z_accel = printer.configfile.settings["printer"].max_z_accel %}
    {% set print_height = printer.toolhead.position.z|float %}
    {% set max_z = printer.toolhead.axis_maximum.z|float %}

    # Turn off bed, extruder, and set fan to 5%
    M140 S0
    M104 S0
    M106 S12.8  # 5% fan speed

    # Switch to relative mode
    G91
    # Retract filament and lift nozzle
    G1 X2 Y2 E-2 F2700
    G1 E-1 Z0.2 F{current_max_z_velocity}
    #G1 X2 Y2 F3000

    # Z-hop only if print height is at least 10mm below max Z
    {% if print_height < (max_z - 10) %}
        RESPOND MSG="Performing Z-hop (10mm)"
        G1 Z10 F{current_max_z_velocity * 60}
    {% else %}
        RESPOND MSG="Skipping Z-hop (print height too high)"
    {% endif %}

    # Switch to absolute mode and deliver print
    G90

    # Adjusted for 235mm
    G1 X5 Y{printer.toolhead.axis_maximum.y - 10}

    # Disable steppers
    M84 X Y E

    # Clear bed mesh and reset Z offset
    BED_MESH_CLEAR
    SET_GCODE_OFFSET Z=0
